pipeline {
    // agent {
    //     docker {image 'hashicorp/terraform:latest'}
    // }
    agent any
    environment {
        AWS_SECRET_KEY = credentials('aws_secret_key')
        AWS_ACCESS_KEY = credentials('aws_access_key')
    }
        stages {

             stage('Pull Terraform Docker Image') {
                steps {
                    sh "docker pull hashicorp/terraform"
                }
            }

            // stage('Install Additional Packages') {
            //     steps {
            //         dir('/terraform') {
            //         // Install any additional dependencies required by Terraform
            //             sh 'apt-get update && apt-get install -y gnupg software-properties-common'
            //         }
            //     }
            // }

            stage ('Terraform Init') {
                steps {
                    dir("Jenkins_DockerAgent/terraform") {
                        sh 'docker run -i -t hashicorp/terraform:latest init'
                    }
                }
            }

            stage ('Terraform Plan') {
                steps {
                    dir("Jenkins_DockerAgent/terraform") {
                        sh 'docker run -i -t hashicorp/terraform:latest apply'
                    }
                }
            }
            stage ('Terraform Apply') {
                steps {
                    dir("Jenkins_DockerAgent/terraform") {
                        sh 'terraform apply -var="aws_access_key=${AWS_ACCESS_KEY}" -var="aws_secret_key=${AWS_SECRET_KEY}" -auto-approve'
                    }
                }
            }
    }
}